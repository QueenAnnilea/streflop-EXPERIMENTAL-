# .github/workflows/build_streflop_soft_arm64.yml
# Workflow to build the 'streflop' library in software float mode for ARM64 macOS

name: Build Streflop (SoftFloat ARM64)

# Allow manual triggering from the GitHub Actions UI
on: workflow_dispatch

jobs:
  build:
    name: Build streflop lib (soft-float, arm64)
    # Use the latest standard macOS runner
    runs-on: macos-latest

    steps:
      - name: Checkout streflop code
        uses: actions/checkout@v4 # Use latest checkout action

      - name: Create build directory
        run: mkdir build

      - name: Configure CMake
        # This step configures the build. Crucial assumptions:
        # 1. We target ARM64 macOS using CMAKE_OSX_ARCHITECTURES.
        # 2. We force software floats using C/CXX flags with -DSTREFLOP_SOFT.
        #    (The actual project might have a CMake option like -DFORCE_SOFTFLOAT=ON instead).
        # 3. We build a static library (.a) for simplicity.
        run: |
          cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DCMAKE_C_FLAGS="-DSTREFLOP_SOFT" \
            -DCMAKE_CXX_FLAGS="-DSTREFLOP_SOFT" \
            -DBUILD_SHARED_LIBS=OFF
        shell: bash

      - name: Build streflop library
        # Assumes standard Makefiles are generated by CMake
        run: |
          cd build
          make -j$(sysctl -n hw.ncpu) # Use available cores
        shell: bash

      - name: Prepare artifact contents
        # Create a directory structure for the artifact
        # Include the static library and necessary headers
        run: |
          mkdir -p artifact/lib
          mkdir -p artifact/include
          cp build/libstreflop.a artifact/lib/
          # Ensure the main streflop header is included
          cp streflop.h artifact/include/
          # Add other necessary headers if SoftFloatWrapper.h etc. are needed by engine
          # Check the streflop source to see if these exist and are needed:
          # cp SoftFloatWrapper.h artifact/include/ # Example, if it exists
          # cp FPUSettings.h artifact/include/ # Example, if it exists
          # cp softfloat/softfloat.h artifact/include/ # Example, if SoftFloat headers are needed directly
        shell: bash

      - name: Upload streflop artifact
        # Upload the 'artifact' directory containing lib and headers
        uses: actions/upload-artifact@v4
        with:
          name: streflop-soft-arm64-lib # Name for the artifact
          path: artifact/ # Path to the directory to upload

